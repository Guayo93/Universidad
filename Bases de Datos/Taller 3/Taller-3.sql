/*ELIMINACION TABLAS*/
DROP TABLE DIAN;
DROP TABLE MOVIMIENTOS;
DROP TABLE TITULARES;
DROP TABLE CUENTAS;
DROP TABLE OFICINAS;
DROP TABLE CLIENTES;

/*CREACION TABLAS*/
CREATE TABLE CLIENTES
(
  CODIGO_CLIENTE NUMERIC(3,0) PRIMARY KEY,
  NOMBRE VARCHAR2(60),
  APELLIDO VARCHAR2(60),
  FECHA_NACIMIENTO DATE,
  GENERO CHAR(1)
);

CREATE TABLE OFICINAS
(
  CODIGO_OFICINA NUMERIC(3,0) PRIMARY KEY,
  NOMBRE_OFICINA VARCHAR2(60)
);

CREATE TABLE CUENTAS
(
  NUMERO_CUENTA NUMERIC(3,0) PRIMARY KEY,
  TIPO CHAR(2),
  CODIGO_OFICINA NUMERIC(3,0),
  SALDO NUMERIC(12,2),
  VALOR_APERTURA NUMERIC(12,2),
  FOREIGN KEY (CODIGO_OFICINA) REFERENCES OFICINAS
);

CREATE TABLE TITULARES
(
  CODIGO_CLIENTE NUMERIC(3,0),
  NUMERO_CUENTA NUMERIC(3,0),
  PRIMARY KEY (CODIGO_CLIENTE, NUMERO_CUENTA),
  FOREIGN KEY (CODIGO_CLIENTE) REFERENCES CLIENTES,
  FOREIGN KEY (NUMERO_CUENTA) REFERENCES CUENTAS
);

CREATE TABLE MOVIMIENTOS
(
  NUMERO_CUENTA NUMERIC(3,0),
  NUMERO NUMERIC(3,0),
  TIPO CHAR(2),
  VALOR NUMERIC(10,2),
  PRIMARY KEY (NUMERO_CUENTA, NUMERO),
  FOREIGN KEY (NUMERO_CUENTA) REFERENCES CUENTAS
);

/*INSERCIONES*/
INSERT INTO CLIENTES VALUES (1, 'PEDRO', 'PEREZ', TO_DATE('18/01/1980', 'DD/MM/YYYY'), 'M');
INSERT INTO CLIENTES VALUES (2, 'MARIA', 'RESTREPO', TO_DATE('18/02/1970', 'DD/MM/YYYY'), 'F');
INSERT INTO CLIENTES VALUES (3, 'JUANA', 'ARIAS', TO_DATE('18/03/1990', 'DD/MM/YYYY'), 'F');
INSERT INTO CLIENTES VALUES (4, 'CARLOS', 'LOZANO', TO_DATE('18/04/2000', 'DD/MM/YYYY'), 'M');
INSERT INTO CLIENTES VALUES (5, 'ESTEBAN', 'GONZALEZ', TO_DATE('18/02/2001', 'DD/MM/YYYY'), 'M');
INSERT INTO CLIENTES VALUES (6, 'JOHN', 'HURTADO', TO_DATE('20/02/1970', 'DD/MM/YYYY'), 'M');
INSERT INTO CLIENTES VALUES (7, 'JUANA', 'PEREZ', TO_DATE('08/08/1950', 'DD/MM/YYYY'), 'F');

INSERT INTO OFICINAS VALUES (10, 'JAVERIANA');
INSERT INTO OFICINAS VALUES (20, 'GALERIAS');
INSERT INTO OFICINAS VALUES (30, 'PORTAL 80');
INSERT INTO OFICINAS VALUES (40, 'TEUSAQUILLO');

INSERT INTO CUENTAS(NUMERO_CUENTA, TIPO, CODIGO_OFICINA, VALOR_APERTURA) VALUES (100, 'A', 10, 0);
INSERT INTO CUENTAS(NUMERO_CUENTA, TIPO, CODIGO_OFICINA, VALOR_APERTURA) VALUES (200, 'A', 20, 100);
INSERT INTO CUENTAS(NUMERO_CUENTA, TIPO, CODIGO_OFICINA, VALOR_APERTURA) VALUES (300, 'C', 10, 500);
INSERT INTO CUENTAS(NUMERO_CUENTA, TIPO, CODIGO_OFICINA, VALOR_APERTURA) VALUES (400, 'C', 10, 1000);
INSERT INTO CUENTAS(NUMERO_CUENTA, TIPO, CODIGO_OFICINA, VALOR_APERTURA) VALUES (500, 'A', 10, 100);
INSERT INTO CUENTAS(NUMERO_CUENTA, TIPO, CODIGO_OFICINA, VALOR_APERTURA) VALUES (600, 'A', 20, 50);

INSERT INTO MOVIMIENTOS VALUES (100, 1, 'D', 10000);
INSERT INTO MOVIMIENTOS VALUES (100, 2, 'D', 25000);
INSERT INTO MOVIMIENTOS VALUES (100, 3, 'C', 5000);
INSERT INTO MOVIMIENTOS VALUES (400, 1, 'D', 58000);

INSERT INTO TITULARES VALUES (1, 100);
INSERT INTO TITULARES VALUES (1, 200);
INSERT INTO TITULARES VALUES (2, 100);
INSERT INTO TITULARES VALUES (2, 200);
INSERT INTO TITULARES VALUES (3, 300);
INSERT INTO TITULARES VALUES (4, 400);
INSERT INTO TITULARES VALUES (5, 500);
INSERT INTO TITULARES VALUES (6, 600);

/*CONSULTAS*/

-- 1.
WITH C_X_T AS
  (SELECT * 
    FROM TITULARES NATURAL LEFT OUTER JOIN CUENTAS),
     CL_X_CT AS
  (SELECT *
    FROM C_X_T NATURAL LEFT OUTER JOIN CLIENTES),
    OF_X_CLCT AS
  (SELECT *
    FROM CL_X_CT FULL OUTER JOIN OFICINAS
    ON CL_X_CT.CODIGO_OFICINA = OFICINAS.CODIGO_OFICINA),
    COUNT_M AS
  (SELECT NOMBRE_OFICINA, COUNT(*) AS NUMERO_CLIENTES_HOMBRES
    FROM OF_X_CLCT
    WHERE GENERO LIKE 'M'
    GROUP BY NOMBRE_OFICINA),
    COUNT_F AS
  (SELECT NOMBRE_OFICINA, COUNT(*) AS NUMERO_CLIENTES_MUJERES
    FROM OF_X_CLCT
    WHERE GENERO LIKE 'F'
    GROUP BY NOMBRE_OFICINA),
    COUNT_MF AS
  (SELECT *
    FROM COUNT_M NATURAL JOIN COUNT_F),
    AVG_AM AS
  (SELECT NOMBRE_OFICINA, AVG(VALOR_APERTURA) AS AVG_A_HOMBRES
    FROM OF_X_CLCT
    WHERE TIPO = 'A' AND GENERO = 'M'
    GROUP BY NOMBRE_OFICINA),
    AVG_AF AS
  (SELECT NOMBRE_OFICINA, AVG(VALOR_APERTURA) AS AVG_A_MUJERES
    FROM OF_X_CLCT
    WHERE TIPO = 'A' AND GENERO = 'F'
    GROUP BY NOMBRE_OFICINA),
    AVG_AMF AS
  (SELECT *
    FROM AVG_AM NATURAL JOIN AVG_AF)
SELECT *
  FROM AVG_AMF NATURAL JOIN COUNT_MF;
  
-- 2.
WITH CL_X_T AS
  (SELECT *
    FROM CLIENTES NATURAL LEFT OUTER JOIN TITULARES),
    COUNT_C AS
  (SELECT NOMBRE, COUNT(CODIGO_CLIENTE) AS NUMERO_CUENTAS
    FROM CL_X_T
    GROUP BY NOMBRE)
SELECT *
  FROM COUNT_C;
  
SELECT *
  FROM CUENTAS;

-- 3.
UPDATE CUENTAS CU
  SET CU.SALDO =
  (WITH MOV_X_C AS
    (SELECT CUENTAS.NUMERO_CUENTA AS NUM_C, MOVIMIENTOS.TIPO AS MOV_T, MOVIMIENTOS.VALOR AS MOV_V
      FROM MOVIMIENTOS, CUENTAS
      WHERE CUENTAS.NUMERO_CUENTA = MOVIMIENTOS.NUMERO_CUENTA),
       SUM_DEBS AS
    (SELECT NUM_C, SUM(MOV_V) AS SUMA
      FROM MOV_X_C
      WHERE MOV_T = 'D'
      GROUP BY NUM_C)
    SELECT SUMA
    FROM SUM_DEBS SD
    WHERE CU.NUMERO_CUENTA = SD.NUM_C) - 
  (WITH MOV_X_C AS
  (SELECT CUENTAS.NUMERO_CUENTA AS NUM_C, MOVIMIENTOS.TIPO AS MOV_T, MOVIMIENTOS.VALOR AS MOV_V
    FROM MOVIMIENTOS, CUENTAS
    WHERE CUENTAS.NUMERO_CUENTA = MOVIMIENTOS.NUMERO_CUENTA),
    SUM_CREDS AS
  (SELECT NUM_C, SUM(MOV_V) SUMA
    FROM MOV_X_C
    WHERE MOV_T = 'C'
    GROUP BY NUM_C)
  SELECT SUMA
    FROM SUM_CREDS SC
    WHERE CU.NUMERO_CUENTA = SC.NUM_C);

SELECT *
  FROM CUENTAS;

-- 4.
CREATE TABLE DIAN
(
  CODIGO_CLIENTE NUMERIC(3,0) PRIMARY KEY,
  SALDO NUMERIC(12,2),
  FOREIGN KEY (CODIGO_CLIENTE) REFERENCES CLIENTES
);

INSERT INTO DIAN
  WITH T_X_C AS
    (SELECT *
      FROM TITULARES NATURAL JOIN CUENTAS)
  SELECT *
    FROM T_X_C
    ORDER BY CODIGO_CLIENTE ASC;
    
SELECT *
  FROM DIAN;